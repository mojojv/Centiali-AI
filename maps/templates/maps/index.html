{% extends 'base.html' %}

{% block title %}Mapas Interactivos{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* Full height map override */
    .map-container {
        height: calc(100vh - 64px);
        /* Header height substracted */
        width: 100%;
        position: relative;
    }

    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }

    .glass-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<!-- Quitamos el container del main layout para full width hack via JS o CSS override específico -->
<div class="-m-6"> <!-- Negative margin to break out of padding -->
    <div class="map-container">

        <div id="map"></div>

        <!-- Floating Controls Panel -->
        <div class="absolute top-4 right-4 z-[400] w-80 glass-panel rounded-xl shadow-2xl p-4 transition-transform duration-300 transform translate-x-0"
            id="controlsPanel">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                <h3 class="font-bold text-slate-800"><i class="fas fa-filter mr-2 text-primary-600"></i>Filtros de Mapa
                </h3>
                <button class="text-gray-400 hover:text-gray-600 text-sm"><i class="fas fa-sync-alt"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Tipo de Incidente</label>
                    <select id="filterType"
                        class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="all">Todos los Incidentes</option>
                        <option value="Heridos">Con Heridos</option>
                        <option value="Solo Daños">Solo Daños</option>
                        <option value="Muertos">Con Fallecidos</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Rango de Fecha</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" class="bg-white border border-gray-200 rounded-lg px-2 py-1 text-sm">
                        <input type="date" class="bg-white border border-gray-200 rounded-lg px-2 py-1 text-sm">
                    </div>
                </div>

                <div class="pt-2">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Mostrar Heatmap</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" id="toggleHeatmap">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600">
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <p class="text-xs text-blue-800">
                        <i class="fas fa-info-circle mr-1"></i> Visualizando <span class="font-bold"
                            id="counter">0</span> incidentes
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<!-- Leaflet Heat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Map
        const map = L.map('map').setView([6.2442, -75.5812], 13);

        // Dark/Modern Tile Layer (CartoDB Voyager)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        const markers = L.markerClusterGroup({
            chunkedLoading: true,
            disableClusteringAtZoom: 17
        });

        let allData = [];

        // Load Data
        fetch('/maps/api/incidentes/')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error cargando datos: ' + data.error);
                    return;
                }

                allData = data.incidentes;
                document.getElementById('counter').innerText = allData.length;
                renderMarkers(allData);
            })
            .catch(err => console.error('Error fetching data:', err));

        // Render Markers Function
        function renderMarkers(data) {
            markers.clearLayers();

            data.forEach(incidente => {
                if (incidente.latitud && incidente.longitud) {
                    const lat = parseFloat(incidente.latitud);
                    const lon = parseFloat(incidente.longitud);

                    // Color coding logic
                    let iconColor = 'blue';
                    if (incidente.gravedad === 'Heridos') iconColor = 'orange';
                    if (incidente.gravedad === 'Muertos') iconColor = 'red';

                    const popupContent = `
                        <div class="p-2 min-w-[200px]">
                            <h4 class="font-bold text-gray-900 mb-1">${incidente.tipo_incidente || 'Incidente'}</h4>
                            <span class="px-2 py-0.5 rounded text-xs text-white bg-${iconColor === 'orange' ? 'yellow-500' : (iconColor === 'red' ? 'red-600' : 'blue-500')} font-bold mb-2 inline-block">${incidente.gravedad}</span>
                            <p class="text-sm text-gray-600 mb-1"><i class="far fa-calendar mr-1"></i> ${new Date(incidente.fecha).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-600 truncate"><i class="fas fa-map-marker-alt mr-1"></i> ${incidente.direccion}</p>
                            <p class="text-xs text-gray-400 mt-2 border-t pt-1">${incidente.descripcion || ''}</p>
                        </div>
                    `;

                    // Basic marker for now (could be custom icon)
                    const marker = L.marker([lat, lon]);
                    marker.bindPopup(popupContent);
                    markers.addLayer(marker);
                }
            });

            map.addLayer(markers);
        }

        // Filter Logic
        document.getElementById('filterType').addEventListener('change', (e) => {
            const val = e.target.value;
            if (val === 'all') {
                renderMarkers(allData);
                document.getElementById('counter').innerText = allData.length;
            } else {
                const filtered = allData.filter(d => d.gravedad === val); // Ajustar según columna real
                renderMarkers(filtered);
                document.getElementById('counter').innerText = filtered.length;
            }
        });
    });
</script>
{% endblock %}